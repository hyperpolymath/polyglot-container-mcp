# SPDX-License-Identifier: PMPL-1.0-or-later
# SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions: read-all

jobs:
  language-policy:
    name: Enforce Language Policy
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Check for prohibited TypeScript files
        run: |
          echo "=== Language Policy Check ==="
          echo "Policy: ReScript is the primary language. TypeScript is PROHIBITED."
          echo ""

          # Check for .ts files (TypeScript)
          TS_FILES=$(find . -name "*.ts" -not -path "./node_modules/*" -not -path "./.git/*" | head -20)
          if [ -n "$TS_FILES" ]; then
            echo "ERROR: TypeScript files detected!"
            echo "Files found:"
            echo "$TS_FILES"
            echo ""
            echo "This project uses ReScript for type safety, not TypeScript."
            echo "Please convert these files to ReScript (.res) or remove them."
            exit 1
          fi

          # Check for .tsx files
          TSX_FILES=$(find . -name "*.tsx" -not -path "./node_modules/*" -not -path "./.git/*" | head -20)
          if [ -n "$TSX_FILES" ]; then
            echo "ERROR: TypeScript React files detected!"
            echo "$TSX_FILES"
            exit 1
          fi

          echo "OK: No TypeScript files found"

      - name: Verify ReScript source exists
        run: |
          RES_COUNT=$(find ./src -name "*.res" 2>/dev/null | wc -l)
          if [ "$RES_COUNT" -eq 0 ]; then
            echo "WARNING: No ReScript source files found in ./src"
            echo "Expected ReScript files for core modules."
          else
            echo "OK: Found $RES_COUNT ReScript source files"
            find ./src -name "*.res" | head -20
          fi

  rescript-build:
    name: Build ReScript
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4.1.1
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build ReScript
        run: npm run res:build

      - name: Verify compiled output
        run: |
          if [ ! -d "lib/es6" ]; then
            echo "ERROR: ReScript compilation did not produce lib/es6 output"
            exit 1
          fi
          echo "OK: ReScript compiled successfully"
          ls -la lib/es6/src/

  deno-check:
    name: Deno Compatibility Check
    runs-on: ubuntu-latest
    needs: rescript-build
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Deno
        uses: denoland/setup-deno@e95548e56dfa95d4e1a28d6f422fafe75c4c26fb # v2
        with:
          deno-version: v1.x

      - name: Setup Node.js (for ReScript)
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4.1.1
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install and build
        run: |
          npm ci
          npm run res:build

      - name: Check Deno compatibility
        run: |
          # Basic syntax check of the main entry point
          deno check --allow-import index.js || echo "Note: Full Deno check requires container runtimes"

  lint:
    name: Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Deno
        uses: denoland/setup-deno@e95548e56dfa95d4e1a28d6f422fafe75c4c26fb # v2
        with:
          deno-version: v1.x

      - name: Lint JavaScript
        run: deno lint --ignore=node_modules,lib || true

      - name: Format check
        run: deno fmt --check --ignore=node_modules,lib || true
