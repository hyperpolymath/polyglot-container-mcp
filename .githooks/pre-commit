#!/bin/bash
# SPDX-License-Identifier: MIT
# SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell

# polyglot-container-mcp Pre-commit Hook
# Enforces language policy: ReScript YES, TypeScript NO

set -e

echo "=== polyglot-container-mcp Pre-commit Hook ==="

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0

# =============================================================================
# CHECK 1: No TypeScript files allowed
# =============================================================================
echo -n "Checking for prohibited TypeScript files... "

# Get staged .ts and .tsx files
TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -n "$TS_FILES" ]; then
    echo -e "${RED}FAILED${NC}"
    echo ""
    echo -e "${RED}ERROR: TypeScript files are PROHIBITED in this project!${NC}"
    echo ""
    echo "This project uses ReScript for type safety. TypeScript is not allowed."
    echo ""
    echo "Prohibited files staged for commit:"
    echo "$TS_FILES" | while read f; do echo "  - $f"; done
    echo ""
    echo "Resolution options:"
    echo "  1. Convert to ReScript (.res) - PREFERRED"
    echo "  2. Convert to plain JavaScript (.js) - acceptable for v1.x"
    echo "  3. Remove the file if not needed"
    echo ""
    ERRORS=1
else
    echo -e "${GREEN}OK${NC}"
fi

# =============================================================================
# CHECK 2: ReScript files should compile
# =============================================================================
echo -n "Checking ReScript compilation... "

# Get staged .res files
RES_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.resi?$' || true)

if [ -n "$RES_FILES" ]; then
    if command -v npx &> /dev/null && [ -f "package.json" ]; then
        if ! npm run res:build > /dev/null 2>&1; then
            echo -e "${RED}FAILED${NC}"
            echo ""
            echo -e "${RED}ERROR: ReScript compilation failed!${NC}"
            echo "Run 'npm run res:build' to see detailed errors."
            ERRORS=1
        else
            echo -e "${GREEN}OK${NC}"
        fi
    else
        echo -e "${YELLOW}SKIPPED${NC} (npm not available)"
    fi
else
    echo -e "${GREEN}OK${NC} (no ReScript files changed)"
fi

# =============================================================================
# CHECK 3: New adapters should be in ReScript (warning only for v1.x)
# =============================================================================
echo -n "Checking new adapter language... "

NEW_JS_ADAPTERS=$(git diff --cached --name-only --diff-filter=A | grep -E '^adapters/.*\.js$' || true)

if [ -n "$NEW_JS_ADAPTERS" ]; then
    echo -e "${YELLOW}WARNING${NC}"
    echo ""
    echo -e "${YELLOW}WARNING: New JavaScript adapter(s) detected:${NC}"
    echo "$NEW_JS_ADAPTERS" | while read f; do echo "  - $f"; done
    echo ""
    echo "For v1.x this is acceptable, but please consider:"
    echo "  - Writing new adapters in ReScript (src/adapters/*.res)"
    echo "  - Converting this adapter to ReScript before v2.0.0"
    echo ""
    # Not an error for v1.x, just a warning
else
    echo -e "${GREEN}OK${NC}"
fi

# =============================================================================
# RESULT
# =============================================================================
echo ""
if [ $ERRORS -ne 0 ]; then
    echo -e "${RED}Pre-commit checks FAILED. Please fix the errors above.${NC}"
    echo ""
    echo "To bypass this hook (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    exit 1
else
    echo -e "${GREEN}All pre-commit checks passed!${NC}"
fi
